<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WebScraper</title>
    <style>
      :root {
        --mainColor: #0ec6c6;
        --mainColor2: #30eded;
        --optionalColor: #666666;
        --whiteColor: #ffffff;
        --blackColor: #221638;
        --fontSize: 15px;
        --transition: 0.5s;
      }

      /* --- Base Styles --- */
      body {
        font-family: "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(
          135deg,
          var(--mainColor2),
          var(--mainColor2)
        );
        color: var(--blackColor);
        font-size: var(--fontSize);
        backdrop-filter: blur(4px);
      }

      h2 {
        text-align: center;
        font-size: 28px;
        margin-bottom: 30px;
        color: var(--blackColor);
      }

      /* --- Form Styling --- */
      form {
        background: rgba(255, 255, 255, 0.6);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        backdrop-filter: blur(10px);
      }

      label {
        font-weight: 600;
        color: var(--blackColor);
      }

      input[type="text"],
      input[type="number"] {
        padding: 10px 14px;
        border: 1px solid var(--optionalColor);
        border-radius: 10px;
        background-color: var(--whiteColor);
        color: var(--blackColor);
        width: 220px;
        transition: border var(--transition);
      }

      input[type="text"]:focus,
      input[type="number"]:focus {
        border-color: var(--mainColor);
        outline: none;
      }

      /* --- Button Styling --- */
      button[type="submit"] {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10px;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid var(--mainColor);
        background: none;
        color: var(--mainColor);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(14, 198, 198, 0.2);
        transition: all var(--transition);
      }
      .download-btn {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 10px;
        padding: 10px 16px;
        font-size: 16px;
        border-radius: 10px;
        border: 1px solid var(--whiteColor);
        background: none;
        color: var(--whiteColor);
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(14, 198, 198, 0.2);
        transition: all var(--transition);
      }

      button[type="submit"]:hover,
      .download-btn:hover {
        background-color: var(--mainColor);
        color: var(--whiteColor);
      }

      .download-btn {
        margin-left: auto;
        margin-bottom: 20px;
      }

      .download-btn svg {
        width: 24px;
        height: 24px;
        fill: currentColor;
      }

      /* --- Table Wrapper --- */
      .table-wrapper {
        overflow-x: auto;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(8px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-top: 20px;
      }

      /* --- Table Styling --- */
      table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1000px;
        background-color: var(--whiteColor);
        border-radius: 12px;
        overflow: hidden;
      }

      thead th {
        background-color: var(--mainColor);
        color: var(--whiteColor);
        padding: 10px 12px;
        text-align: left;
        font-weight: 600;
        white-space: nowrap;
      }

      tbody td {
        padding: 8px 12px;
        font-size: var(--fontSize);
        vertical-align: top;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border-top: 1px solid #eee;
      }

      tbody tr:nth-child(even) {
        background-color: #f9fcff;
      }

      tbody tr:hover {
        background-color: rgba(14, 198, 198, 0.05);
        transition: background-color var(--transition);
      }

      /* --- Link Styling --- */
      a {
        color: var(--mainColor);
        text-decoration: none;
        font-weight: 500;
      }

      a:hover {
        color: var(--mainColor2);
        text-decoration: underline;
      }

      /* --- Responsive Mobile Layout --- */
      @media (max-width: 768px) {
        .table-wrapper {
          overflow-x: unset;
        }

        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
          width: 100%;
        }

        thead {
          display: none;
        }

        tr {
          margin-bottom: 16px;
          background-color: rgba(255, 255, 255, 0.9);
          border-radius: 10px;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
          padding: 10px;
        }

        td {
          padding: 10px 15px;
          text-align: left;
          white-space: normal;
          overflow: visible;
          position: relative;
        }

        td::before {
          content: attr(data-label);
          font-weight: 600;
          color: var(--mainColor);
          display: block;
          margin-bottom: 4px;
        }

        form {
          flex-direction: column;
          align-items: stretch;
        }

        input[type="text"],
        input[type="number"],
        button[type="submit"],
        .download-btn {
          width: 100%;
        }

        .download-btn {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="loader" style="display: none"></div>

    <form method="get" action="/">
      <label for="query">Search Query:</label>
      <input type="text" id="query" name="query" required value="{{ query }}" />

      <label for="page_count">Page Count:</label>
      <input
        type="number"
        id="page_count"
        name="page_count"
        min="1"
        required
        value="{{ page_count }}"
      />

      <button type="submit">Search</button>
    </form>

    <button id="downloadCsvBtn" class="download-btn" title="Download CSV">
      <svg
        class="download-icon"
        xmlns="http://www.w3.org/2000/svg"
        width="24"
        height="24"
        fill="currentColor"
        viewBox="0 0 24 24"
      >
        <path d="M5 20h14v-2H5v2zm7-18l-5.5 5.5h3.5v6h4v-6h3.5L12 2z" />
      </svg>
      Download CSV
    </button>

    <div style="overflow-x: auto; border-radius: 16px">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Business Name</th>
            <th>URL</th>
            <th>Snippet</th>
            <th>Center Name</th>
            <th>Address</th>
            <th>City</th>
            <th>State</th>
            <th>Country</th>
            <th>Zipcode</th>
            <th>Email</th>
            <th>Website</th>
            <th>Phone</th>
            <th>WhatsApp</th>
            <th>Facebook</th>
            <th>Instagram</th>
            <th>Twitter</th>
            <th>TikTok</th>
            <th>LinkedIn</th>
            <th>Services</th>
          </tr>
        </thead>
        <tbody>
          {% for row in data %}
          <tr>
            <td>{{ row.id }}</td>
            <td>{{ row.business_name }}</td>
            <td>
              <a href="{{ row.url }}" target="_blank" rel="noopener noreferrer"
                >Link</a
              >
            </td>
            <td>{{ row.snippet }}</td>
            <td>{{ row.center_name }}</td>
            <td>{{ row.address }}</td>
            <td>{{ row.city }}</td>
            <td>{{ row.state }}</td>
            <td>{{ row.country if row.country else '-' }}</td>
            <td>{{ row.zipcode }}</td>
            <td>{{ row.email if row.email else '-' }}</td>
            <td>
              <a
                href="{{ row.website }}"
                target="_blank"
                rel="noopener noreferrer"
                >Website</a
              >
            </td>
            <td>{{ row.phone }}</td>
            <td>
              {% if row.whatsapp %}<a href="{{ row.whatsapp }}" target="_blank"
                >WhatsApp</a
              >{% else %}-{% endif %}
            </td>
            <td>
              {% if row.facebookurl %}<a
                href="{{ row.facebookurl }}"
                target="_blank"
                >Facebook</a
              >{% else %}-{% endif %}
            </td>
            <td>
              {% if row.instagramurl %}<a
                href="{{ row.instagramurl }}"
                target="_blank"
                >Instagram</a
              >{% else %}-{% endif %}
            </td>
            <td>
              {% if row.twitterurl %}<a
                href="{{ row.twitterurl }}"
                target="_blank"
                >Twitter</a
              >{% else %}-{% endif %}
            </td>
            <td>
              {% if row.tiktokurl %}<a
                href="{{ row.tiktokurl }}"
                target="_blank"
                >TikTok</a
              >{% else %}-{% endif %}
            </td>
            <td>
              {% if row.linkedinurl %}<a
                href="{{ row.linkedinurl }}"
                target="_blank"
                >LinkedIn</a
              >{% else %}-{% endif %}
            </td>
            <td>{{ ", ".join(row.services) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const data = {{ data_json | safe }}

        function downloadCSV() {
          if (!data || data.length === 0) {
            alert("No data available for download");
            return;
          }

          const headers = [
            "ID",
            "Business Name",
            "URL",
            "Snippet",
            "Center Name",
            "Address",
            "City",
            "State",
            "Country",
            "Zipcode",
            "Email",
            "Website",
            "Phone",
            "WhatsApp",
            "Facebook",
            "Instagram",
            "Twitter",
            "TikTok",
            "LinkedIn",
            "Services",
          ];

          const rows = data.map((row) =>
            [
              row.id,
              `"${(row.business_name || "").replace(/"/g, '""')}"`,
              row.url,
              `"${(row.snippet || "").replace(/"/g, '""')}"`,
              `"${(row.center_name || "").replace(/"/g, '""')}"`,
              `"${(row.address || "").replace(/"/g, '""')}"`,
              row.city,
              row.state,
              row.country || "",
              row.zipcode,
              row.email || "",
              row.website,
              row.phone,
              row.whatsapp || "",
              row.facebookurl || "",
              row.instagramurl || "",
              row.twitterurl || "",
              row.tiktokurl || "",
              row.linkedinurl || "",
              `"${(row.services || []).join(", ").replace(/"/g, '""')}"`,
            ].join(",")
          );

          const csvContent = [headers.join(","), ...rows].join("\n");

          const blob = new Blob([csvContent], {
            type: "text/csv;charset=utf-8;",
          });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          const query = document.getElementById("query").value.trim().replace(/\s+/g, "_");
          a.download = `${query || "confinement_nannies"}_data.csv`;

          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        }

        document
          .getElementById("downloadCsvBtn")
          .addEventListener("click", downloadCSV);
      });
    </script>
  </body>
</html>
